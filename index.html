<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Probabilistic Novel Generator</title>
<style>
  html,body{
    height:100%;margin:0;padding:0;
    font-family:"American Typewriter","Times New Roman",serif;
    background:#000;color:#fff;overflow:hidden;
  }
  /* Background canvases stacked */
  #bg-maze, #bg-particles, #bg-morse {
    position:fixed;inset:0;z-index:-3;display:block;width:100%;height:100%;
  }
  #bg-particles {z-index:-2;pointer-events:none;}
  #bg-morse {z-index:-1;pointer-events:none;}
  /* Foreground novel */
  #content{
    position:relative;z-index:10;
    height:100%;width:100%;
    overflow-y:auto;padding:20px;
    background:rgba(0,0,0,0.35);backdrop-filter:blur(4px);
  }
  #generate{padding:8px 14px;font-size:14px;margin-bottom:10px;cursor:pointer}
  #output{white-space:pre-wrap;line-height:1.4}
</style>
</head>
<body>
  <!-- Background layers -->
  <canvas id="bg-maze"></canvas>
  <canvas id="bg-particles" width="1280" height="720"></canvas>
  <canvas id="bg-morse" width="1280" height="720"></canvas>

  <!-- Foreground Novel -->
  <div id="content">
    <button id="generate">Loading time…</button>
    <div id="output">Loading sources…</div>
  </div>

<script>
/* === Background MAZE (30fps) === */
(function(){
  const canvas=document.getElementById("bg-maze");
  const ctx=canvas.getContext("2d");
  function resize(){canvas.width=innerWidth;canvas.height=innerHeight;}
  window.addEventListener("resize",resize);resize();
  let size=21;
  function genMaze(n){const g=Array.from({length:n},()=>Array(n).fill(1));
    function carve(x,y){[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5).forEach(([dx,dy])=>{
      const nx=x+dx*2,ny=y+dy*2;
      if(nx>0&&ny>0&&nx<n-1&&ny<n-1&&g[ny][nx]===1){g[y+dy][x+dx]=0;g[ny][nx]=0;carve(nx,ny);}
    });}
    g[1][1]=0;carve(1,1);return g;}
  let map=genMaze(size);
  const player={x:1.5,y:1.5,dir:0};
  function draw(){
    ctx.fillStyle="#223";ctx.fillRect(0,0,canvas.width,canvas.height);
    const rays=canvas.width,step=(60*Math.PI/180)/rays;
    for(let i=0;i<rays;i++){
      const a=player.dir-(30*Math.PI/180)+i*step;
      let x=player.x,y=player.y,d=0,hit=false;
      while(!hit&&d<size){x+=Math.cos(a)*.05;y+=Math.sin(a)*.05;d+=.05;
        if(map[Math.floor(y)]?.[Math.floor(x)]===1)hit=true;}
      if(hit){const h=(1/d)*canvas.height*.7;
        ctx.fillStyle=`hsl(220,20%,${50-20*Math.min(d/size,1)}%)`;
        ctx.fillRect(i,canvas.height/2-h/2,1,h);}
    }
  }
  setInterval(draw,1000/30);
})();

/* === PARTICLE DRIFT === */
(function(){
  const canvas=document.getElementById("bg-particles"),ctx=canvas.getContext("2d");
  function reset(p){const cx=canvas.width/2,cy=canvas.height/2,a=Math.random()*Math.PI*2,R=Math.random()*Math.min(canvas.width,canvas.height)/3;
    p.x=cx+Math.cos(a)*R;p.y=cy+Math.sin(a)*R;p.vx=(Math.random()-.5)*.2;p.vy=(Math.random()-.5)*.2;
    p.alpha=.4+Math.random()*.6;p.mode=Math.random()<.4?"spiral":"drift";p.angle=a;p.radius=R;p.center=[cx,cy];}
  const ps=[];for(let i=0;i<8;i++){const p={};reset(p);ps.push(p);}
  function draw(){ctx.fillStyle="rgba(0,0,0,0.08)";ctx.fillRect(0,0,canvas.width,canvas.height);
    for(const p of ps){if(p.mode==="drift"){p.x+=p.vx;p.y+=p.vy;}else{p.angle+=.01;p.radius+=.02;p.x=p.center[0]+Math.cos(p.angle)*p.radius;p.y=p.center[1]+Math.sin(p.angle)*p.radius;}
      if(Math.random()<.0015)reset(p);ctx.fillStyle="rgba(255,255,255,"+p.alpha+")";ctx.fillRect(p.x,p.y,1,1);}requestAnimationFrame(draw);}draw();
})();

/* === MORSE PIXEL FLOW === */
(function(){
  const canvas=document.getElementById("bg-morse"),ctx=canvas.getContext("2d");
  const W=canvas.width,H=canvas.height,unit=180;
  const MAP={"A":".-","B":"-...","C":"-.-.","D":"-..","E":".","F":"..-.","G":"--.","H":"....","I":"..","J":".---","K":"-.-","L":".-..","M":"--","N":"-.","O":"---","P":".--.","Q":"--.-","R":".-.","S":"...","T":"-","U":"..-","V":"...-","W":".--","X":"-..-","Y":"-.--","Z":"--.."};
  const MSG=["SOS","HELLO","CODE","REVEAL"];
  function tokens(msg){const t=[];for(const ch of msg){const c=MAP[ch];if(!c)continue;for(let i=0;i<c.length;i++){t.push({on:true,ms:c[i]=="."?unit:unit*3});if(i<c.length-1)t.push({on:false,ms:unit});}t.push({on:false,ms:unit*3});}return t;}
  const morse={tokens:tokens("SOS"),idx:0,remain:unit,color:"red",x:W/2,y:H/2,angle:0,r:0};
  function reset(){morse.tokens=tokens(MSG[Math.floor(Math.random()*MSG.length)]);morse.idx=0;morse.remain=morse.tokens[0]?.ms||unit;
    morse.color="hsla("+Math.floor(Math.random()*360)+",100%,60%,1)";morse.angle=0;morse.r=0;morse.x=W/2;morse.y=H/2;}
  reset();
  let last=performance.now();
  function draw(now){const dt=now-last;last=now;ctx.fillStyle="rgba(0,0,0,0.08)";ctx.fillRect(0,0,W,H);
    morse.remain-=dt;while(morse.remain<=0){morse.idx++;if(morse.idx>=morse.tokens.length){reset();break;}else{morse.remain+=morse.tokens[morse.idx].ms;}}
    morse.angle+=.02;morse.r+=.03;morse.x=W/2+Math.cos(morse.angle)*morse.r;morse.y=H/2+Math.sin(morse.angle)*morse.r;
    const t=morse.tokens[morse.idx];if(t&&t.on){ctx.fillStyle=morse.color;ctx.fillRect(morse.x,morse.y,3,3);}
    requestAnimationFrame(draw);}draw(performance.now());
})();

/* === NOVEL GENERATOR === */
function updateTime(){document.getElementById("generate").textContent=new Date().toLocaleTimeString();}
setInterval(updateTime,1000);updateTime();
async function loadSources(){const s={bible:"pg10681-images.html",dict:"pg30-images.html",jsons:["wordnet_1.json","wordnet_2.json"]};
async function f(u){try{const r=await fetch(u);return await r.text()}catch(e){return""}};return{bible:await f(s.bible),dict:await f(s.dict),jsonText:(await Promise.all(s.jsons.map(f))).join("\\n")};}
function generateNovel(src){const rand=Math.random();let c;if(rand<.09)c=src.bible;else if(rand<.59)c=src.dict;else c=src.jsonText;const w=c.split(/\\s+/);let o=[];for(let i=0;i<100;i++)o.push(w[Math.floor(Math.random()*w.length)]);return o.join(" ");}
let sourcesCache=null;loadSources().then(s=>{sourcesCache=s;document.getElementById("output").textContent="Sources loaded. Click the time button to generate.";});
document.getElementById("generate").addEventListener("click",()=>{document.getElementById("output").textContent=sourcesCache?generateNovel(sourcesCache):"Still loading sources…";});
</script>
</body>
</html>
