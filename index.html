<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Probabilistic Novel Generator</title>
<style>
  html,body{margin:0;padding:0;height:100%;background:#fff;color:#000;}
  body{font-family:"Times New Roman", Times, serif; font-size:12px; line-height:1.45; padding:24px;}
  #novel{white-space:normal; word-wrap:break-word;}
  .meta{font-family:"American Typewriter","Courier New",monospace;font-size:12px;margin-bottom:12px;}
  #loader{position:fixed;left:12px;top:12px;background:rgba(255,255,255,0.95);padding:8px 12px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
  #controls{position:fixed;right:12px;top:12px;background:rgba(255,255,255,0.95);padding:8px 12px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
  button{font-family:inherit;padding:6px 8px;border-radius:4px;border:1px solid #ccc;background:#f7f7f7;cursor:pointer}
</style>
</head>
<body>
<div id="loader" class="meta">Building novel â€” generating 1,000,000 words (client-side)...</div>
<div id="controls" class="meta"><button id="regen">Regenerate</button> <button id="download">Download text</button></div>
<main id="novel" aria-live="polite" role="main"></main>

<script>
(function(){
  function stripTags(html){return html.replace(/<script[\s\S]*?<\/script>/gi,' ').replace(/<style[\s\S]*?<\/style>/gi,' ').replace(/<[^>]+>/g,' ');}
  function wordsFromText(txt){return txt.replace(/\s+/g,' ').trim().split(' ').filter(Boolean);}
  function weightedChoice(weights){var sum=0;for(var i=0;i<weights.length;i++)sum+=weights[i].w;
    var r=Math.random()*sum,cum=0;for(var i=0;i<weights.length;i++){cum+=weights[i].w;if(r<=cum)return weights[i].val;}return weights[weights.length-1].val;}

  var pools=[],targetWords=1000000,novelEl,loader;

  function generateOnce(){
    loader.style.display='block';novelEl.textContent='';
    var parts=[],total=0;
    while(total<targetWords){
      var p=weightedChoice(pools.map(x=>({w:x.weight,val:x})));
      var len=Math.floor(Math.random()*100)+20;
      var start=Math.floor(Math.random()*(p.words.length-len));
      var slice=p.words.slice(start,start+len);
      parts.push(slice.join(' '));
      total+=slice.length;
    }
    novelEl.textContent=parts.join(' ').split(' ').slice(0,targetWords).join(' ');
    loader.style.display='none';
  }

  async function init(){
    novelEl=document.getElementById('novel');
    loader=document.getElementById('loader');
    try{
      const [bibleRes,dictRes,jsonRes]=await Promise.all([
        fetch('pg10681-images.html'),fetch('pg30-images.html'),fetch('wordnet_single.json')
      ]);
      const [bibleTxt,dictTxt,jsonTxt]=await Promise.all([bibleRes.text(),dictRes.text(),jsonRes.text()]);
      var bible_words=wordsFromText(stripTags(bibleTxt));
      var dict_words=wordsFromText(stripTags(dictTxt));
      var json_words=[];
      try{
        var parsed=JSON.parse(jsonTxt),collected=[];
        (function walk(o){if(!o)return;if(typeof o==='string'){collected.push(o);return;}
          if(Array.isArray(o)){o.forEach(walk);return;}
          if(typeof o==='object'){for(var k in o)walk(o[k]);}})(parsed);
        json_words=collected.join(' ').replace(/\s+/g,' ').trim().split(' ').filter(Boolean);
      }catch(e){json_words=wordsFromText(jsonTxt);}

      pools=[
        {words:bible_words.length?bible_words:['missing'],weight:0.09},
        {words=dict_words.length?dict_words:['missing'],weight:0.50},
        {words=json_words.length?json_words:['missing'],weight:0.41}
      ];
      generateOnce();
    }catch(err){loader.textContent='Error loading sources: '+err;}
  }

  document.getElementById('regen').onclick=function(){setTimeout(generateOnce,50);};
  document.getElementById('download').onclick=function(){
    var text=novelEl.textContent;
    var blob=new Blob([text],{type:'text/plain'}),url=URL.createObjectURL(blob);
    var a=document.createElement('a');a.href=url;a.download='generated_novel.txt';a.click();
    setTimeout(function(){URL.revokeObjectURL(url);},1500);
  };

  init();
})();
</script>
</body>
</html>
