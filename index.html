<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Probabilistic Novel Generator</title>
  <style>
    body {
      font-family: "American Typewriter", "Times New Roman", serif;
      font-size: 12px;
      background: white;
      color: black;
      margin: 20px;
    }
    #generate {
      font-family: "American Typewriter", "Times New Roman", serif;
      font-size: 12px;
      padding: 6px 12px;
      margin-bottom: 10px;
    }
    #output {
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <button id="generate">Loading time…</button>
  <div id="output">Loading sources…</div>

  <script>
    // Update button label with device time
    function updateTime() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString();
      document.getElementById("generate").textContent = timeStr;
    }
    setInterval(updateTime, 1000);
    updateTime();

    // Load sources
    async function loadSources() {
      const sources = {
        bible: "pg10681-images.html",
        dict: "pg30-images.html",
        jsons: ["wordnet_1.json", "wordnet_2.json"]
      };

      async function fetchText(url) {
        try {
          const r = await fetch(url);
          return await r.text();
        } catch (e) {
          console.error("Error fetching", url, e);
          return "";
        }
      }

      const bible = await fetchText(sources.bible);
      const dict = await fetchText(sources.dict);
      const jsonParts = await Promise.all(sources.jsons.map(fetchText));
      const jsonText = jsonParts.join("\n");

      return { bible, dict, jsonText };
    }

    // Generate random text
    function generateNovel(sources) {
      const rand = Math.random();
      let chosen;
      if (rand < 0.09) {
        chosen = sources.bible;
      } else if (rand < 0.59) {
        chosen = sources.dict;
      } else {
        chosen = sources.jsonText;
      }
      const words = chosen.split(/\s+/);
      let out = [];
      for (let i = 0; i < 100; i++) {
        out.push(words[Math.floor(Math.random() * words.length)]);
      }
      return out.join(" ");
    }

    // Main
    let sourcesCache = null;
    loadSources().then(src => {
      sourcesCache = src;
      document.getElementById("output").textContent = "Sources loaded. Click the time button to generate.";
    });

    document.getElementById("generate").addEventListener("click", () => {
      if (sourcesCache) {
        document.getElementById("output").textContent = generateNovel(sourcesCache);
      } else {
        document.getElementById("output").textContent = "Still loading sources…";
      }
    });
  </script>
</body>
</html>
